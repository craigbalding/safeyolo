# Service Discovery

SafeYolo uses dynamic service discovery to identify which agent is making each request,
enabling per-agent credential policies.

## Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                       HOST (your machine)                     │
│                                                               │
│  ┌─────────────────────┐        ┌─────────────────────────┐  │
│  │     safeyolo CLI    │        │    services.yaml        │  │
│  │                     │───────▶│                         │  │
│  │  - agent add        │ writes │  myproject:             │  │
│  │  - agent run        │        │    ip: 172.20.0.3       │  │
│  │  - start            │        │  work:                  │  │
│  └─────────────────────┘        │    ip: 172.20.0.4       │  │
│          │                      └─────────────────────────┘  │
│          │ queries Docker                    │               │
│          ▼                                   │ mounted       │
│  ┌───────────────────┐                       ▼               │
│  │  Docker daemon    │        ┌─────────────────────────────┐│
│  │                   │        │     safeyolo container      ││
│  │  Network state    │        │                             ││
│  │  (dynamic IPs)    │        │  service_discovery.py       ││
│  └───────────────────┘        │  Maps IP → agent for        ││
│                               │  credential isolation       ││
│                               └─────────────────────────────┘│
└──────────────────────────────────────────────────────────────┘
```

## How It Works

**Dynamic Discovery (default):**
1. `safeyolo agent add myproject claude-code ~/code` creates config and runs agent
2. Agent container joins the safeyolo Docker network with a Docker-assigned IP
3. CLI queries Docker network to discover container IPs
4. Writes `services.yaml` mapping container name → IP
5. SafeYolo proxy reads `services.yaml` to map IP → agent name

IPs are assigned dynamically by Docker, not statically by the CLI.

**Integrated Users (Pro Teams):**
1. Provide your own `services.yaml` with IP ranges
2. Mount to `/app/data/services.yaml` in container
3. No CLI dependency

## Configuration

### services.yaml

Located at `~/.safeyolo/data/services.yaml` (auto-generated by CLI) or mounted to `/app/data/services.yaml`.

```yaml
# Auto-generated by safeyolo CLI - do not edit manually
# Regenerate with: safeyolo sync
# Last updated: 2024-01-15T10:30:00Z

services:
  myproject:
    ip: "172.20.0.3"
    project: myproject

  work:
    ip: "172.20.0.4"
    project: work
```

### Regeneration

The CLI regenerates `services.yaml` automatically when:
- Starting SafeYolo (`safeyolo start`)
- Running an agent (`safeyolo agent run`)
- Syncing (`safeyolo sync`)

To manually regenerate:
```bash
safeyolo sync
```

## Lookup Priority

1. **Exact IP match** - Check if IP is in services.yaml
2. **IP range match** - Check if IP falls within any `ip_range` (pro teams)
3. **Default** - Return "default" project

## Pro Team Integration

For teams with existing infrastructure, you can provide a custom `services.yaml`:

```yaml
services:
  # Kubernetes pods
  k8s-agents:
    ip_range: "10.244.0.0/16"
    project: k8s-cluster

  # EC2 instances
  aws-workers:
    ip_range: "172.16.0.0/12"
    project: aws-team

  # Development machines
  dev-team:
    ip_range: "192.168.1.0/24"
    project: developers
```

Mount this file to `/app/data/services.yaml` when running the safeyolo container.

## Docker Access Requirements

The CLI requires Docker access to manage agent containers:

```bash
# Check if you have Docker access
safeyolo setup check

# If needed, add yourself to docker group
sudo usermod -aG docker $USER
newgrp docker  # or log out and back in
```

The SafeYolo container itself does NOT need Docker socket access. It only reads
the static `services.yaml` configuration.

## Troubleshooting

### All requests show "default" project

1. Check services.yaml exists: `cat ~/.safeyolo/data/services.yaml`
2. Regenerate: `safeyolo sync`
3. Verify IP mapping matches your container's IP
4. Restart safeyolo to reload config

### Agent container can't reach SafeYolo

1. Verify both are on the `safeyolo_internal` network
2. Check agent can resolve `safeyolo` hostname
3. Verify proxy environment variables are set in container

### Agent not showing in services.yaml

1. Check agent is running: `docker ps`
2. Regenerate services: `safeyolo sync`
3. Or manually run: `safeyolo agent run <name>`
