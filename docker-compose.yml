# SafeYolo - Development Infrastructure
#
# FOR DEVELOPMENT ONLY. Docker assigns subnet automatically.
# For production, use the CLI: safeyolo init --sandbox
#
# Owns the internal network that all project containers join.
# Provides: mitmproxy gateway, CC dev sidecar, service discovery
#
# Start first: docker compose up -d
# Projects then join the internal network (safeyolo_internal)
#
# Non-root execution (recommended):
#   echo "SAFEYOLO_UID=$(id -u)" >> .env
#   echo "SAFEYOLO_GID=$(id -g)" >> .env
#   docker compose up -d
#
# Network: Docker picks subnet automatically. Use DNS names (e.g., "safeyolo") not IPs.
#
# For shell_mux integration (Claude Code command execution):
#   See docker-compose.override.yml.example
#
# Networks:
#   - internal (safeyolo_internal): All containers (projects + CC) live here, no direct internet
#   - default: SafeYolo's internet access (the only outbound path)

services:
  certs-init:
    image: alpine:3.20
    user: "0:0"
    volumes:
      - type: volume
        source: safeyolo-certs-private
        target: /certs-private
        volume:
          nocopy: true
      - type: volume
        source: safeyolo-ca
        target: /certs-public
        volume:
          nocopy: true
    command: ["sh","-c","chown ${SAFEYOLO_UID:-1000}:${SAFEYOLO_GID:-1000} /certs-private /certs-public && chmod 700 /certs-private && chmod 755 /certs-public"]

  # ============================================================
  # SafeYolo Gateway (mitmproxy with native addons)
  # - Single chokepoint for ALL outbound internet traffic
  # - Native mitmproxy addons: credential_guard, request_logger, admin_api
  # - Service discovery via sudoers (no socket mount needed)
  # ============================================================
  safeyolo:
    depends_on:
      certs-init:
        condition: service_completed_successfully
    build:
      context: .
      # target: base  # Lightweight core addons (~200MB)
      # target: extended  # Uncomment for ML + YARA (~700MB)
      target: dev       # Development with pytest
    container_name: safeyolo
    # Run as host user for correct volume permissions (non-root)
    user: "${SAFEYOLO_UID:-1000}:${SAFEYOLO_GID:-1000}"
    #restart: unless-stopped
    networks:
      internal:
        # Reachable via Docker DNS name "safeyolo"
      default:
        # Internet access
    ports:
      - "127.0.0.1:8888:8080"   # Proxy port (localhost only)
      - "127.0.0.1:9090:9090"   # Admin API (localhost only)
    volumes:
      - type: volume
        source: safeyolo-certs-private
        target: /certs-private
        volume:
          nocopy: true

      - type: volume
        source: safeyolo-ca
        target: /certs-public
        volume:
          nocopy: true
      # Dev mount - entire project for live editing
      # For production, use selective mounts instead
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
      # Dev mounts for live editing - remove for production use
      - ./addons:/app/addons
      - ./pdp:/app/pdp
      - ./scripts:/app/scripts
      - ./models:/app/models
      - ./tests:/app/tests
      # Runtime env (dynamically updatable)
      - ./.env:/app/.env
      #- .:/app
    command: ["/app/scripts/start-safeyolo.sh"]
    env_file:
      - .env
    environment:
      - PROXY_PORT=8080
      - ADMIN_PORT=9090
      - MITMPROXY_LOG_LEVEL=debug
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1

networks:
  # Internal network - all project containers join this
  # No direct internet access - must go through SafeYolo
  # Docker assigns subnet automatically
  internal:
    driver: bridge
    internal: true

  # Default network - only SafeYolo uses this for internet
  default:
    driver: bridge

volumes:
  safeyolo-certs-private:
    name: safeyolo-certs-private
  safeyolo-ca:
    name: safeyolo-ca
