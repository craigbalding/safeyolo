# SafeYolo Black Box Test Harness
#
# Usage:
#   docker compose up --build --abort-on-container-exit
#   docker compose run test-runner pytest test_credential_guard.py -v
#   docker compose run test-runner bash  # Interactive debugging
#
# Architecture:
#   - safeyolo: The proxy under test (built from project root)
#   - sinkhole: Multi-host HTTP server capturing all traffic
#   - test-runner: Pytest-based test suite
#
# All hostnames (api.openai.com, evil.com, etc.) resolve to sinkhole
# within the test network via Docker network aliases.

services:
  # SafeYolo proxy (the system under test)
  safeyolo:
    build:
      context: ../..
      target: dev
    container_name: safeyolo-test
    networks:
      testnet:
        aliases:
          - safeyolo
    ports:
      - "18080:8080"  # Proxy (for debugging)
      - "19090:9090"  # Admin API (for debugging)
    volumes:
      - ./config:/app/config:ro
      - safeyolo-test-certs:/certs-private
      - safeyolo-test-ca:/certs-public
      - safeyolo-test-logs:/app/logs
      - safeyolo-test-data:/app/data
    environment:
      - PROXY_PORT=8080
      - ADMIN_PORT=9090
      - SAFEYOLO_BLOCK=true
      # Test token for deterministic auth
      - ADMIN_API_TOKEN=test-token-for-blackbox-tests
    command: ["/app/scripts/start-safeyolo.sh"]
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import httpx; httpx.get('http://localhost:9090/health', timeout=2)",
        ]
      interval: 5s
      timeout: 10s
      retries: 12
      start_period: 30s

  # Sinkhole: captures all traffic for inspection
  sinkhole:
    build: ./sinkhole
    container_name: sinkhole
    networks:
      testnet:
        aliases:
          # All test hostnames resolve to sinkhole within testnet
          - api.openai.com
          - api.anthropic.com
          - api.github.com
          - evil.com
          - attacker.com
          - httpbin.org
          - failing.test
          - legitimate-api.com
    ports:
      - "19999:9999"  # Control API (for debugging)
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import httpx; httpx.get('http://localhost:9999/health', timeout=2)",
        ]
      interval: 2s
      timeout: 5s
      retries: 10

  # Test runner
  test-runner:
    build: ./runner
    container_name: test-runner
    networks:
      - testnet
    depends_on:
      safeyolo:
        condition: service_healthy
      sinkhole:
        condition: service_healthy
    environment:
      - PROXY_URL=http://safeyolo:8080
      - ADMIN_URL=http://safeyolo:9090
      - ADMIN_API_TOKEN=test-token-for-blackbox-tests
      - SINKHOLE_API=http://sinkhole:9999
      # Disable SSL verification warnings for cleaner output
      - PYTHONWARNINGS=ignore:Unverified HTTPS request
    volumes:
      # Mount test files for development iteration
      - ./runner:/app:ro

networks:
  testnet:
    driver: bridge

volumes:
  safeyolo-test-certs:
  safeyolo-test-ca:
  safeyolo-test-logs:
  safeyolo-test-data:
