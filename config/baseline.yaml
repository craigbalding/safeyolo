# SafeYolo Baseline Policy
#
# Default protections for AI coding agents. This policy:
# - Routes credentials to their correct hosts (OpenAI keys -> api.openai.com)
# - Rate-limits common services to prevent IP blacklisting
# - Requires approval for credentials going to unknown destinations
#
# Customize by editing this file or mounting your own policy.yaml
#
# Policy schema (destination-first for credential:use):
#   - resource = destination pattern (the endpoint being protected)
#   - condition.credential = what credentials can access it

metadata:
  version: "1.0"
  description: "SafeYolo baseline policy"

# =============================================================================
# PERMISSIONS
# =============================================================================

permissions:
  # ---------------------------------------------------------------------------
  # Credential Routing - Which credentials can reach which hosts
  # ---------------------------------------------------------------------------

  # OpenAI endpoints accept OpenAI credentials
  - action: credential:use
    resource: "api.openai.com/*"
    effect: allow
    tier: explicit
    condition:
      credential: ["openai:*"]

  # Anthropic endpoints accept Anthropic credentials
  - action: credential:use
    resource: "api.anthropic.com/*"
    effect: allow
    tier: explicit
    condition:
      credential: ["anthropic:*"]

  # GitHub endpoints accept GitHub credentials
  - action: credential:use
    resource: "api.github.com/*"
    effect: allow
    tier: explicit
    condition:
      credential: ["github:*"]

  - action: credential:use
    resource: "github.com/*"
    effect: allow
    tier: explicit
    condition:
      credential: ["github:*"]

  # Unknown destinations require approval
  - action: credential:use
    resource: "*"
    effect: prompt
    tier: explicit

  # ---------------------------------------------------------------------------
  # Rate Limits (requests per minute) - Prevent runaway agents
  # ---------------------------------------------------------------------------

  # LLM APIs - high volume
  - action: network:request
    resource: "api.openai.com/*"
    effect: budget
    budget: 3000  # 50 rps
    tier: explicit

  - action: network:request
    resource: "api.anthropic.com/*"
    effect: budget
    budget: 3000  # 50 rps
    tier: explicit

  - action: network:request
    resource: "openrouter.ai/*"
    effect: budget
    budget: 3000  # 50 rps
    tier: explicit

  # GitHub API - conservative (has its own rate limits)
  - action: network:request
    resource: "api.github.com/*"
    effect: budget
    budget: 300  # 5 rps
    tier: explicit

  # Google APIs
  - action: network:request
    resource: "*.googleapis.com/*"
    effect: budget
    budget: 120  # 2 rps
    tier: explicit

  # Package registries - devs install packages frequently
  - action: network:request
    resource: "pypi.org/*"
    effect: budget
    budget: 1200  # 20 rps
    tier: explicit

  - action: network:request
    resource: "files.pythonhosted.org/*"
    effect: budget
    budget: 1200  # 20 rps
    tier: explicit

  - action: network:request
    resource: "registry.npmjs.org/*"
    effect: budget
    budget: 600  # 10 rps
    tier: explicit

  # Rust crates.io (cargo does parallel fetches)
  - action: network:request
    resource: "index.crates.io/*"
    effect: budget
    budget: 3000  # 50 rps - index lookups
    tier: explicit

  - action: network:request
    resource: "static.crates.io/*"
    effect: budget
    budget: 1200  # 20 rps - downloads
    tier: explicit

  - action: network:request
    resource: "crates.io/*"
    effect: budget
    budget: 600  # 10 rps
    tier: explicit

  # Go modules
  - action: network:request
    resource: "proxy.golang.org/*"
    effect: budget
    budget: 300  # 5 rps
    tier: explicit

  - action: network:request
    resource: "sum.golang.org/*"
    effect: budget
    budget: 300  # 5 rps
    tier: explicit

  # Default rate limit for all other domains
  - action: network:request
    resource: "*"
    effect: budget
    budget: 600  # 10 rps default
    tier: explicit

# =============================================================================
# GLOBAL BUDGETS
# =============================================================================

budgets:
  network:request: 12000  # Total requests per minute across all domains

# =============================================================================
# REQUIRED ADDONS (cannot be disabled)
# =============================================================================

required:
  - credential_guard
  - network_guard
  - circuit_breaker

# =============================================================================
# CREDENTIAL DETECTION AND ROUTING RULES
# =============================================================================
# Define patterns for detecting credential types and their allowed destinations.
# Used by credential_guard for detection and policy evaluation for routing.

credential_rules:
  - name: openai
    patterns:
      - "sk-[a-zA-Z0-9]{20}T3BlbkFJ[a-zA-Z0-9]{20}"
      - "sk-proj-[a-zA-Z0-9_-]{80,}"
    allowed_hosts:
      - api.openai.com
    header_names:
      - authorization
      - x-api-key

  - name: anthropic
    patterns:
      - "sk-ant-api[a-zA-Z0-9-]{90,}"
    allowed_hosts:
      - api.anthropic.com
    header_names:
      - authorization
      - x-api-key

  - name: github
    patterns:
      - "gh[ps]_[a-zA-Z0-9]{36}"
    allowed_hosts:
      - api.github.com
      - github.com
    header_names:
      - authorization

# =============================================================================
# ADDON CONFIGURATION
# =============================================================================

addons:
  network_guard:
    enabled: true

  credential_guard:
    enabled: true
    detection_level: standard  # standard | paranoid

  circuit_breaker:
    enabled: true

  pattern_scanner:
    enabled: true
    # Optional builtin pattern sets (disabled by default)
    # Available: secrets, pii
    builtin_sets: []
    # Set pattern_block_request=true or pattern_block_response=true to enable blocking

# =============================================================================
# DOMAIN OVERRIDES
# =============================================================================

domains:
  # Internal services - bypass extra scanning
  "*.internal":
    bypass:
      - pattern_scanner

# =============================================================================
# EXAMPLES (uncomment and customize as needed)
# =============================================================================

# --- Example: Add a custom credential type ---
# Add to permissions section:
#
#   - action: credential:use
#     resource: "api.myservice.com/*"
#     effect: allow
#     tier: explicit
#     condition:
#       credential: ["myservice:*"]
#
# Then add the pattern to your rules.json or credential_rules.json

# --- Example: Approve a specific credential by HMAC fingerprint ---
# You don't need to add these manually - SafeYolo prompts for approval on
# first use via `safeyolo watch`. Approved credentials are saved automatically.
#
# This example is for PRE-APPROVING credentials to avoid the prompt (e.g., in
# CI/CD or when deploying a known configuration). The fingerprint is shown
# when SafeYolo blocks a credential, or generate it with:
#
#   python scripts/generate_fingerprint.py
#
# Add to permissions section:
#
#   - action: credential:use
#     resource: "api.custom.com/*"
#     effect: allow
#     tier: explicit
#     condition:
#       credential: ["hmac:a1b2c3d4e5f6..."]

# --- Example: Add rate limits for a new domain ---
# Add to permissions section:
#
#   - action: network:request
#     resource: "api.newservice.com/*"
#     effect: budget
#     budget: 600  # requests per minute
#     tier: explicit

# --- Example: Bypass scanners for trusted domains ---
# Add to domains section:
#
#   "trusted.internal.com":
#     bypass:
#       - pattern_scanner
#       - credential_guard  # only if you fully trust this domain

# --- Example: Enable SSE streaming for a domain ---
# Add to domains section:
#
#   "streaming.example.com":
#     addons:
#       sse_streaming:
#         enabled: true

# =============================================================================
# PATTERN SCANNER - User-Defined Pattern Detection
# =============================================================================
#
# pattern_scanner detects arbitrary patterns in URLs, headers, and/or bodies.
# Unlike credential_guard (which handles credential ROUTING), pattern_scanner
# handles pattern DETECTION for domain-specific sensitive data.
#
# Two ways to configure:
#
# 1. BUILTIN SETS - Enable pre-defined pattern sets in addons.pattern_scanner:
#      pattern_scanner:
#        builtin_sets: [secrets]  # Available: secrets, pii
#
# 2. CUSTOM PATTERNS - Define your own in scan_patterns below
#
# Pattern configuration:
#   - name: Rule name (shown in logs and block responses)
#   - pattern: Regex pattern to match
#   - target: Direction - "request" | "response" | "both"
#   - scope: Where to look - list of "url" | "headers" | "body" (default: [body])
#   - action: What to do - "block" | "log"
#   - severity: For logging - "low" | "medium" | "high" | "critical"
#   - message: Custom message shown on match
#   - case_sensitive: true (default) | false
#
# To enable blocking, set mitmproxy options:
#   --set pattern_block_request=true   # Block matching requests
#   --set pattern_block_response=true  # Block matching responses

scan_patterns: []
  # Uncomment and customize examples below:
  #
  # --- Prevent internal project IDs from leaking (URL or body) ---
  # - name: internal-project-ids
  #   pattern: "PROJ-[0-9]{5}"
  #   target: request
  #   scope: [body, url]
  #   action: block
  #   severity: high
  #   message: "Internal project ID detected - use external reference instead"
  #
  # --- Audit customer ID boundary crossings ---
  # - name: customer-ids
  #   pattern: "CUST-[A-Z]{3}-\\d{6}"
  #   target: both
  #   scope: [body]
  #   action: log
  #   severity: medium
  #   message: "Customer ID crossed proxy boundary"
  #
  # --- Block restricted classification markers (check everywhere) ---
  # - name: restricted-markers
  #   pattern: "(CONFIDENTIAL|INTERNAL-ONLY|DO-NOT-SHARE)"
  #   target: request
  #   scope: [body, url, headers]
  #   action: block
  #   severity: critical
  #   case_sensitive: false
  #   message: "Restricted classification marker detected"
  #
  # --- Healthcare: Protect patient identifiers ---
  # - name: patient-mrn
  #   pattern: "MRN[0-9]{10}"
  #   target: both
  #   scope: [body]
  #   action: block
  #   severity: critical
  #   message: "Patient MRN detected - use de-identified reference"
  #
  # --- Finance: Log account number crossings ---
  # - name: account-numbers
  #   pattern: "ACCT-[0-9]{12}"
  #   target: both
  #   scope: [body, url]
  #   action: log
  #   severity: high
  #   message: "Account number crossed boundary"
  #
  # --- Compliance: Block export-controlled terms ---
  # - name: export-control
  #   pattern: "(ITAR|EAR99|ECCN-[0-9A-Z]+)"
  #   target: request
  #   scope: [body]
  #   action: block
  #   severity: critical
  #   message: "Export-controlled term detected"
