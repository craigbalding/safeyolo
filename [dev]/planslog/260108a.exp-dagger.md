# Session: Dagger Module for SafeYolo

**Date:** 2026-01-08  
**Type:** Experimental  
**Status:** Complete

## Objective

Create a Dagger module that produces the same Docker container as `docker-compose.yml`.

## Requirements (from user)

- Dagger v0.19.9
- TypeScript SDK
- Bun 1.3.5 runtime (not Node)

## Files Created

| File | Purpose |
|------|---------|
| `dagger/dagger.json` | Module config (engineVersion: v0.19.9) |
| `dagger/package.json` | Bun dependencies (@dagger.io/dagger) |
| `dagger/tsconfig.json` | TypeScript config (ESNext, bundler) |
| `dagger/src/index.ts` | Module implementation (204 lines) |
| `dagger/AGENTS.md` | AI agent memory for future sessions |
| `dagger/README.md` | Human-readable documentation |

## Module Functions Implemented

```typescript
class Safeyolo {
  base(): Container           // Build base container (~200MB)
  dev(): Container            // Build dev container with pytest
  serve(proxyPort?, adminPort?): Container  // Run with exposed ports
  withConfig(dir): Container  // Mount custom config
  withData(dir): Container    // Mount data directory
  export(target?): string     // Export as tarball
  publish(address, target?): string  // Push to registry
}
```

## Key Design Decisions

1. **Pinned base image** with SHA256 digest (supply chain security)
2. **Hash-verified pip install** using `--require-hashes`
3. **Source from parent directory** (`..`) to access project files
4. **Two build targets**: base (core) and dev (with pytest)

## What's Replicated from Dockerfile

- Multi-stage build logic (base â†’ dev)
- System deps: tmux
- Python deps from `requirements/base.txt`, `requirements/dev.txt`
- Directory structure: `/app/{addons,config,pdp,scripts,logs}`
- Environment variables (PROXY_PORT, ADMIN_PORT, PYTHONPATH, etc.)
- Exposed ports: 8080, 8888, 9090

## What's NOT Replicated

- Network orchestration (safeyolo-internal) - Dagger doesn't manage networks
- Volume persistence - use `withConfig()`/`withData()` at runtime
- `certs-init` service - cert setup happens in `start-safeyolo.sh`

## Usage

```bash
cd dagger
bun install
dagger call base          # Build base
dagger call dev           # Build dev
dagger call serve         # Run proxy
dagger call publish --address ghcr.io/user/safeyolo
```

## Next Steps (documented in AGENTS.md)

- [ ] Add `test()` function to run pytest suite
- [ ] Add caching for pip dependencies
- [ ] Add multi-arch build support (arm64)
- [ ] Add integration with CI (GitHub Actions)

## References

- `/Dockerfile` - Original build definition
- `/docker-compose.yml` - Service configuration  
- `/scripts/start-safeyolo.sh` - Entrypoint logic
