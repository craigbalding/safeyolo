name: Blackbox Tests

# Blackbox tests validate SafeYolo's security guarantees end-to-end.
#
# Two test suites:
#   - Proxy tests: Credential routing, network guard via sinkhole inspection
#   - Isolation tests: Container hardening (CDK), network isolation, key isolation
#
# These tests run SafeYolo as a black box using the production startup
# script. See docs/security-testing-design.md for architecture details.
#
# NOTE: pull_request trigger removed intentionally. Blackbox tests are slow
# (~5 min) and iteration-heavy PRs would burn runner minutes. Security coverage
# is preserved via: (1) push-to-main gate, (2) daily scheduled run.

on:
  schedule:
    - cron: '0 3 * * *'  # 3am UTC daily
  workflow_dispatch:  # Manual trigger from GitHub UI
  push:
    branches: [master, main]
    paths:
      - 'addons/**'
      - 'pdp/**'
      - 'config/**'
      - 'scripts/start-safeyolo.sh'
      - 'tests/blackbox/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/blackbox.yml'

# Cancel in-progress runs when a new commit is pushed (e.g., rapid merges).
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  blackbox:
    name: Security Blackbox Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run blackbox tests
        run: ./tests/blackbox/run-tests.sh

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: blackbox-test-logs
          path: |
            tests/blackbox/logs/
          retention-days: 7
