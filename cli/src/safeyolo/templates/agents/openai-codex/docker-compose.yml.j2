# {{ instance_name }} ({{ agent_name }}) - SafeYolo Sandbox Mode
# Generated by: safeyolo agent add {{ instance_name }} {{ agent_name }} <folder>
#
# Network isolation: This container has NO direct internet access.
# All traffic is routed through SafeYolo proxy (http://{{ proxy_hostname }}:8080).

services:
  {{ instance_name }}:
    build: .
    hostname: {{ instance_name }}
    # Starts as root to set up home dir ownership, then drops to SAFEYOLO_UID:SAFEYOLO_GID
    stdin_open: true
    tty: true
    networks:
      {{ network_name }}:
        # IP assigned dynamically by Docker
    volumes:
      # Your project directory (override: safeyolo agent run <name> /path/to/project)
      - ${SAFEYOLO_PROJECT_DIR}:/${SAFEYOLO_PROJECT_NAME}
      # SafeYolo public CA cert for HTTPS inspection (no private key access)
      - {{ certs_volume }}:/certs:ro
      # Persist home dir (agent installs, mise languages, shell history)
      - {{ instance_name }}-home:/home/agent
{%- for dir in found_dirs %}
      # Host config: {{ dir }}
      - ${HOME}/{{ dir }}:/home/agent/{{ dir }}
{%- endfor %}
{%- for file in found_files %}
      # Host config: {{ file }}
      - ${HOME}/{{ file }}:/home/agent/{{ file }}
{%- endfor %}
    working_dir: /${SAFEYOLO_PROJECT_NAME}
    environment:
      # Host user UID/GID for privilege drop
      - SAFEYOLO_UID=${SAFEYOLO_UID}
      - SAFEYOLO_GID=${SAFEYOLO_GID}
      # Non-root user home directory
      - HOME=/home/agent
      # Route all traffic through SafeYolo (using Docker DNS name)
      - HTTP_PROXY=http://{{ proxy_hostname }}:8080
      - HTTPS_PROXY=http://{{ proxy_hostname }}:8080
      - http_proxy=http://{{ proxy_hostname }}:8080
      - https_proxy=http://{{ proxy_hostname }}:8080
      - NO_PROXY=localhost,127.0.0.1
      # Silence npm update notifier (noisy, confusing for non-npm users)
      - NO_UPDATE_NOTIFIER=1
      - npm_config_update_notifier=false
      # Trust SafeYolo CA
      - NODE_EXTRA_CA_CERTS=/certs/mitmproxy-ca-cert.pem
      - SSL_CERT_FILE=/certs/mitmproxy-ca-cert.pem
      - REQUESTS_CA_BUNDLE=/certs/mitmproxy-ca-cert.pem
{%- for key, value in docker_env.items() %}
      # From agent.toml [docker.env]
      - {{ key }}={{ value }}
{%- endfor %}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # === Root setup phase ===
        # Set ownership on home volume for host user
        # Pre-create XDG base directories to avoid permission issues when tools create caches
        mkdir -p /home/agent/.cache /home/agent/.config /home/agent/.local/share/mise /home/agent/.local/state
        chown -R "$${SAFEYOLO_UID}:$${SAFEYOLO_GID}" /home/agent
        chmod 700 /home/agent

        # Create user/group entries for the host UID/GID
        echo "agent:x:$${SAFEYOLO_UID}:$${SAFEYOLO_GID}::/home/agent:/bin/bash" >> /etc/passwd
        echo "agent:x:$${SAFEYOLO_GID}:" >> /etc/group
{% if instructions_type == "system_file" and instructions_path %}

        # Inject container instructions (system-level, read by agent)
        mkdir -p "$(dirname '{{ instructions_path }}')"
        cat > '{{ instructions_path }}' << 'SAFEYOLO_INSTRUCTIONS'
{{ instructions_content | indent(8, first=True) }}
        SAFEYOLO_INSTRUCTIONS
{% endif %}

        # === Drop privileges and continue as non-root ===
        exec setpriv --reuid="$${SAFEYOLO_UID}" --regid="$${SAFEYOLO_GID}" --init-groups bash -c '
          # Install agent globally (mise use -g is always trusted)
          mise use -g {{ mise_package }}@latest

          # Record version for audit trail (mise exec for script context)
          VERSION=$$(mise exec -- {{ binary }} --version 2>&1 || echo "unknown")
          echo "SAFEYOLO_AGENT_VERSION agent={{ agent_name }} version=$$VERSION"

          # If authenticated, run agent; otherwise drop to shell for setup
          echo ""
          if [ -f "/home/agent/{{ oauth_file }}" ] || [ -n "$${â€‹{{ auth_env_var }}:-}" ]; then
            echo "(SafeYolo provides network isolation)"
            echo "Shell: safeyolo agent shell {{ instance_name }}"
            echo ""
            # Add auto_args only if SAFEYOLO_YOLO_MODE is set (safeyolo agent run --yolo)
            YOLO_ARGS=""
            if [ -n "$${SAFEYOLO_YOLO_MODE:-}" ]; then
              YOLO_ARGS="{{ agent.run.auto_args_str }}"
              echo "[yolo mode: $${YOLO_ARGS}]"
            fi
{% if instructions_type == "cli_arg" and instructions_arg and instructions_content %}
            # Inject instructions via CLI argument
            exec mise exec -- {{ agent.run.command }} --config {{ instructions_arg }}="{{ instructions_content | replace('"', '\\"') | replace('\n', ' ') }}" {% for arg in agent.run.args %}{{ arg }} {% endfor %}$${YOLO_ARGS}
{% else %}
            exec mise exec -- {{ run_command }} $${YOLO_ARGS}
{% endif %}
          else
            echo "{{ setup_hint }}"
            echo ""
            echo "(SafeYolo provides network isolation)"
            echo ""
            exec bash
          fi
        '

networks:
  {{ network_name }}:
    external: true

volumes:
  {{ certs_volume }}:
    external: true
  {{ instance_name }}-home:
    # Persists home dir: agent installs, mise languages, shell history
