# OpenAI Codex Agent - Secure Mode
# Generated by: safeyolo agent add openai-codex
#
# Network isolation: This container has NO direct internet access.
# All traffic is routed through SafeYolo proxy at {{ safeyolo_ip }}.

services:
  openaicodex:
    image: node:22-slim
    user: "${SAFEYOLO_UID}:${SAFEYOLO_GID}"
    stdin_open: true
    tty: true
    networks:
      {{ network_name }}:
        ipv4_address: {{ agent_ip }}
    volumes:
      # Your project directory
      - {{ project_dir }}:/workspace
      # SafeYolo CA cert for HTTPS inspection
      - {{ certs_volume }}:/certs:ro
{% if has_codex_dir %}
      # Codex config from host (config.toml, AGENTS.md, sessions)
      - ${HOME}/.codex:/home/agent/.codex
{% endif %}
    working_dir: /workspace
    environment:
      # Non-root user home directory
      - HOME=/home/agent
      # Codex config location (matches mounted path)
      - CODEX_HOME=/home/agent/.codex
      # Route all traffic through SafeYolo
      - HTTP_PROXY=http://{{ safeyolo_ip }}:8080
      - HTTPS_PROXY=http://{{ safeyolo_ip }}:8080
      - http_proxy=http://{{ safeyolo_ip }}:8080
      - https_proxy=http://{{ safeyolo_ip }}:8080
      - NO_PROXY=localhost,127.0.0.1
      # Trust SafeYolo CA
      - NODE_EXTRA_CA_CERTS=/certs/mitmproxy-ca-cert.pem
      - SSL_CERT_FILE=/certs/mitmproxy-ca-cert.pem
      - REQUESTS_CA_BUNDLE=/certs/mitmproxy-ca-cert.pem
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Create HOME for arbitrary UID (container runs as host user)
        mkdir -p "$HOME" && chmod 700 "$HOME" || true

        # npm global installs to HOME (not root-owned /usr/local)
        npm config set prefix "$HOME/.npm-global"
        export PATH="$HOME/.npm-global/bin:$PATH"

        # Install Codex CLI if not present
        if ! command -v codex &> /dev/null; then
          echo "Installing OpenAI Codex CLI..."
          npm install -g @openai/codex 2>/dev/null
        fi

        # Record installed version for audit trail
        CODEX_VERSION=$(codex --version 2>/dev/null || echo "unknown")
        echo "SAFEYOLO_AGENT_VERSION agent=openai-codex version=$CODEX_VERSION"

        # Install common dev tools (requires root - skip if non-root)
        if [ "$(id -u)" = "0" ] && ! command -v git &> /dev/null; then
          echo "Installing dev tools..."
          apt-get update && apt-get install -y git curl python3 python3-pip jq > /dev/null 2>&1
        fi

        echo ""
        echo "Ready. Run 'codex --sandbox danger-full-access' to start."
        echo "(SafeYolo provides network isolation, so Codex sandbox is disabled)"
        echo ""
        exec bash

networks:
  {{ network_name }}:
    external: true

volumes:
  {{ certs_volume }}:
    external: true
