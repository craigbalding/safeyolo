# {{ instance_name }} ({{ agent_name }}) - SafeYolo Sandbox Mode
# Generated by: safeyolo agent add {{ instance_name }} {{ agent_name }} <folder>
#
# Network isolation: This container has NO direct internet access.
# All traffic is routed through SafeYolo proxy (http://{{ proxy_hostname }}:8080).

services:
  {{ instance_name }}:
    build: .
    hostname: {{ instance_name }}
    # Starts as root to set up home dir ownership, then drops to SAFEYOLO_UID:SAFEYOLO_GID
    stdin_open: true
    tty: true
    networks:
      {{ network_name }}:
        # IP assigned dynamically by Docker
    volumes:
      # User's folder (override: safeyolo agent run <name> -f /path/to/folder)
      - ${USER_DIR}:/${USER_DIRNAME}
      # SafeYolo public CA cert for HTTPS inspection (no private key access)
      - {{ certs_volume }}:/certs:ro
      # Persist home dir (agent installs, mise languages, shell history)
      - {{ instance_name }}-home:/home/agent
{%- for dir in found_dirs %}
      # Host config: {{ dir }}
      - ${HOME}/{{ dir }}:/home/agent/{{ dir }}
{%- endfor %}
{%- for file in found_files %}
      # Host config: {{ file }}
      - ${HOME}/{{ file }}:/home/agent/{{ file }}
{%- endfor %}
    working_dir: /${USER_DIRNAME}
    environment:
      # Host user UID/GID for privilege drop
      - SAFEYOLO_UID=${SAFEYOLO_UID}
      - SAFEYOLO_GID=${SAFEYOLO_GID}
      # Non-root user home directory
      - HOME=/home/agent
      # Route all traffic through SafeYolo (using Docker DNS name)
      - HTTP_PROXY=http://{{ proxy_hostname }}:8080
      - HTTPS_PROXY=http://{{ proxy_hostname }}:8080
      - http_proxy=http://{{ proxy_hostname }}:8080
      - https_proxy=http://{{ proxy_hostname }}:8080
      - NO_PROXY=localhost,127.0.0.1
      # Silence npm update notifier (noisy, confusing for non-npm users)
      - NO_UPDATE_NOTIFIER=1
      - npm_config_update_notifier=false
      # Trust SafeYolo CA
      - NODE_EXTRA_CA_CERTS=/certs/mitmproxy-ca-cert.pem
      - SSL_CERT_FILE=/certs/mitmproxy-ca-cert.pem
      - REQUESTS_CA_BUNDLE=/certs/mitmproxy-ca-cert.pem
{%- for key, value in docker_env.items() %}
      # From agent.toml [docker.env]
      - {{ key }}={{ value }}
{%- endfor %}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    entrypoint: ["/usr/local/bin/safeyolo-init"]
    command: ["{{ binary }}"]

networks:
  {{ network_name }}:
    external: true

volumes:
  {{ certs_volume }}:
    external: true
  {{ instance_name }}-home:
    # Persists home dir: agent installs, mise languages, shell history
