#!/bin/bash
# SafeYolo agent init - setup then exec to agent binary
# Args passed through: safeyolo-init codex --help â†’ mise exec -- codex --help
set -e

# === Root setup phase ===
mkdir -p /home/agent/.cache /home/agent/.config /home/agent/.local/share/mise /home/agent/.local/state
chown -R "${SAFEYOLO_UID}:${SAFEYOLO_GID}" /home/agent
chmod 700 /home/agent

echo "agent:x:${SAFEYOLO_UID}:${SAFEYOLO_GID}::/home/agent:/bin/bash" >> /etc/passwd
echo "agent:x:${SAFEYOLO_GID}:" >> /etc/group

# === Install agent if needed (as non-root) ===
setpriv --reuid="${SAFEYOLO_UID}" --regid="${SAFEYOLO_GID}" --init-groups \
  bash -c 'mise use -g {{ mise_package }}@latest' 2>/dev/null || true

# === User init hook (runs as non-root, for custom tools/setup) ===
if [ -f /home/agent/.safeyolo-hooks/agent-init.sh ]; then
  setpriv --reuid="${SAFEYOLO_UID}" --regid="${SAFEYOLO_GID}" --init-groups \
    bash /home/agent/.safeyolo-hooks/agent-init.sh
fi

# === Parse command ===
CMD="$1"
shift

# YOLO mode args (safeyolo agent run --yolo)
EXTRA_ARGS=""
if [ -n "${SAFEYOLO_YOLO_MODE:-}" ]; then
  EXTRA_ARGS="{{ agent.run.auto_args_str }}"
  echo "[yolo mode: ${EXTRA_ARGS}]"
fi

{% if instructions_type == "cli_arg" and instructions_arg and instructions_content %}
# Instructions injected via CLI argument (value quoted separately to avoid word-splitting)
INSTRUCTIONS_VALUE="{{ instructions_content | replace('"', '\\"') | replace('\n', ' ') }}"
{% endif %}

# === Auth check ===
if [ -f "/home/agent/{{ oauth_file }}" ] || [ -n "${{ '{' ~ auth_env_var ~ ':-}' }}" ]; then
  echo "(SafeYolo provides network isolation)"
  echo "Shell: safeyolo agent shell {{ instance_name }}"
  echo ""
  # Drop privileges and exec agent with all args
{% if instructions_type == "cli_arg" and instructions_arg and instructions_content %}
  exec setpriv --reuid="${SAFEYOLO_UID}" --regid="${SAFEYOLO_GID}" --init-groups \
    mise exec -- "$CMD" --config "{{ instructions_arg }}=$INSTRUCTIONS_VALUE" $EXTRA_ARGS "$@"
{% else %}
  exec setpriv --reuid="${SAFEYOLO_UID}" --regid="${SAFEYOLO_GID}" --init-groups \
    mise exec -- "$CMD" $EXTRA_ARGS "$@"
{% endif %}
else
  echo "{{ setup_hint }}"
  echo ""
  echo "(SafeYolo provides network isolation)"
  echo ""
  exec setpriv --reuid="${SAFEYOLO_UID}" --regid="${SAFEYOLO_GID}" --init-groups bash
fi
