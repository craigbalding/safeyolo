# Claude Code Agent - Secure Mode
# Generated by: safeyolo agent add claude-code
#
# Network isolation: This container has NO direct internet access.
# All traffic is routed through SafeYolo proxy at {{ safeyolo_ip }}.

services:
  claude:
    image: node:22-slim
    stdin_open: true
    tty: true
    networks:
      - {{ network_name }}
    volumes:
      # Your project directory
      - {{ project_dir }}:/workspace
      # SafeYolo CA cert for HTTPS inspection
      - {{ certs_volume }}:/certs:ro
    working_dir: /workspace
    environment:
      # Route all traffic through SafeYolo
      - HTTP_PROXY=http://{{ safeyolo_ip }}:8080
      - HTTPS_PROXY=http://{{ safeyolo_ip }}:8080
      - http_proxy=http://{{ safeyolo_ip }}:8080
      - https_proxy=http://{{ safeyolo_ip }}:8080
      - NO_PROXY=localhost,127.0.0.1
      # Trust SafeYolo CA
      - NODE_EXTRA_CA_CERTS=/certs/mitmproxy-ca-cert.pem
      - SSL_CERT_FILE=/certs/mitmproxy-ca-cert.pem
      - REQUESTS_CA_BUNDLE=/certs/mitmproxy-ca-cert.pem
      # API key (from .env file)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Install Claude Code if not present
        if ! command -v claude &> /dev/null; then
          echo "Installing Claude Code..."
          npm install -g @anthropic-ai/claude-code 2>/dev/null
        fi
        # Install common dev tools
        if ! command -v git &> /dev/null; then
          echo "Installing dev tools..."
          apt-get update && apt-get install -y git curl python3 python3-pip jq > /dev/null 2>&1
        fi
        echo ""
        echo "Ready. Run 'claude --dangerously-skip-permissions' to start."
        echo "(SafeYolo provides network isolation, so Claude's permission prompts are bypassed)"
        echo ""
        exec bash

networks:
  {{ network_name }}:
    external: true

volumes:
  {{ certs_volume }}:
    external: true
