# SafeYolo Proxy - Generated by safeyolo CLI
# Mode: {% if sandbox %}Sandbox (enforced){% else %}Try (bypassable){% endif %}
#
# Do not edit manually - run 'safeyolo init{% if not sandbox %} --try{% endif %}' to regenerate
{% if sandbox %}
#
# Sandbox Mode: Agent containers on {{ internal_network }} have NO direct
# internet access. All traffic must go through SafeYolo (http://{{ proxy_hostname }}:8080).
#
# Non-root execution: Container runs as UID:GID {{ uid }}:{{ gid }}
# Split certs: Private keys in {{ private_certs_volume }}, public CA in {{ public_certs_volume }}
{% endif %}

services:
{% if sandbox %}
  # Initialize cert volume ownership (runs once before safeyolo)
  certs-init:
    image: alpine:3.20
    user: "0:0"
    volumes:
      - {{ private_certs_volume }}:/certs-private
      - {{ public_certs_volume }}:/certs-public
    command: ["sh", "-c", "chown {{ uid }}:{{ gid }} /certs-private /certs-public && chmod 700 /certs-private && chmod 755 /certs-public"]

{% endif %}
  safeyolo:
{% if sandbox %}
    depends_on:
      certs-init:
        condition: service_completed_successfully
{% endif %}
    image: {{ image }}
    container_name: {{ container_name }}
    user: "{{ uid }}:{{ gid }}"
{% if sandbox %}
    networks:
      {{ internal_network }}:
        # IP assigned dynamically by Docker - agents reach proxy via DNS name
      default:
        # Internet access via default bridge
{% endif %}
    ports:
      - "127.0.0.1:{{ proxy_port }}:8080"
      - "127.0.0.1:{{ admin_port }}:9090"
    volumes:
      - {{ logs_dir }}:/app/logs
      - {{ private_certs_volume }}:/certs-private
{% if sandbox %}
      - {{ public_certs_volume }}:/certs-public
{% else %}
      - {{ certs_dir }}:/certs-public
{% endif %}
      - {{ policies_dir }}:/app/data/policies
      - {{ data_dir }}:/app/data
{% if rules_path %}
      - {{ rules_path }}:/app/config/credential_rules.json:ro
{% endif %}
{% if policy_path %}
      - {{ policy_path }}:/app/config/policy.yaml:ro
{% endif %}
    environment:
      - SAFEYOLO_BLOCK=true
      - CERT_DIR=/certs-private
      - PUBLIC_CERT_DIR=/certs-public
    restart: unless-stopped
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    healthcheck:
      test: ["CMD", "python3", "-c", "import httpx; exit(0 if httpx.get('http://localhost:9090/health', timeout=2).status_code == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

{% if sandbox %}
networks:
  {{ internal_network }}:
    driver: bridge
    internal: true  # No default gateway - agents cannot bypass proxy
    # No static subnet - Docker assigns from available pool (avoids conflicts)

{% endif %}
volumes:
  {{ private_certs_volume }}:
    name: {{ private_certs_volume }}
{% if sandbox %}
  {{ public_certs_volume }}:
    name: {{ public_certs_volume }}
{% endif %}
